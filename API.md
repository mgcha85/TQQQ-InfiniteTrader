# KIS API 연동 확인 가이드

이 문서는 한국투자증권(KIS) API가 정상적으로 동작하는지 확인하는 방법을 설명합니다.
`.env` 파일에 설정된 앱 키와 시크릿, 계좌번호가 올바른지 검증할 수 있습니다.

## 1. 사전 준비

프로젝트의 `backend` 디렉토리로 이동해야 합니다.

```bash
cd backend
```

## 2. 테스트 스크립트 실행

다음 명령어를 통해 테스트 스크립트를 실행합니다. 이 스크립트는 잔고 조회, 현재가 조회, 주문 전송(테스트) 과정을 순차적으로 수행합니다.

```bash
go run cmd/test_trade/main.go
```

## 3. 결과 확인 방법

스크립트 실행 로그를 통해 성공 여부를 확인할 수 있습니다.

### ✅ 성공 케이스

1. **토큰 발급/갱신**
   ```
   [KIS] Token expires at: ... (유효기간 표시)
   ```
   
2. **잔고 조회 (GetBalance)**
   ```
   [KIS] ✓ GetBalance: Found X holdings ...
   ```
   보유 종목 리스트가 출력되면 계좌번호와 API 키가 정상입니다.

3. **현재가 조회 (GetCurrentPrice)**
   ```
   [KIS] ✓ GetCurrentPrice: NAS:TQQQ = $...
   ```
   TQQQ 가격이 정상적으로 출력되어야 합니다.

4. **주문 전송 (PlaceOrder)**
   - **장 운영 시간인 경우**: 주문 성공 메시지
   - **장 운영 시간이 아닌 경우**: 아래와 같은 에러 메시지가 뜨더라도 **API 연동 자체는 성공**한 것입니다.
     ```
     Response Code: 7, Msg: 장운영시간이 아닙니다 ...
     ```
     또는
     ```
     Response Code: 7, Msg: 에프터마켓 연장참여 신청계좌만 주문 가능 합니다.
     ```

### ❌ 실패 케이스 (자주 발생하는 에러)

1. **인증 실패 (401 Unauthorized, gws-exception 등)**
   - `.env` 파일의 `KIS_APP_KEY`, `KIS_APP_SECRET`을 다시 확인해주세요.
   - 키 값에 공백이 포함되어 있는지 확인하세요.

2. **계좌번호 오류 (INVALID_CHECK_ACNO)**
   - `.env`의 `KIS_ACCOUNT_NUM`이 정확한지 확인하세요. (종합계좌번호 8자리)
   - 모의투자가 아닌 **실전투자** 계좌인지 확인하세요. (API URL이 실전용으로 설정됨)

3. **토큰 파일 문제**
   - 만약 계속 인증 에러가 난다면, 기존에 발급받은 토큰 파일이 꼬였을 수 있습니다.
   - `backend/kis_token.json` 파일을 삭제하고 다시 실행해보세요.
   ```bash
   rm kis_token.json
   ```

## 4. 참고 사항
- 이 테스트 스크립트는 실제 주문을 전송하므로, **장 운영 시간에 실행 시 실제 매수/매도가 발생**할 수 있습니다.
- 테스트 목적으로 실행할 때는 장 운영 시간이 아닐 때 하거나, 계좌에 잔고를 비워두는 것을 권장합니다 (혹은 소액만).
