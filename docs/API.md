# KIS API ì—°ë™ í™•ì¸ ê°€ì´ë“œ

ì´ ë¬¸ì„œëŠ” í•œêµ­íˆ¬ìžì¦ê¶Œ(KIS) APIê°€ ì •ìƒì ìœ¼ë¡œ ë™ìž‘í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.
`.env` íŒŒì¼ì— ì„¤ì •ëœ ì•± í‚¤ì™€ ì‹œí¬ë¦¿, ê³„ì¢Œë²ˆí˜¸ê°€ ì˜¬ë°”ë¥¸ì§€ ê²€ì¦í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

## 1. ì‚¬ì „ ì¤€ë¹„

í”„ë¡œì íŠ¸ì˜ `backend` ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•´ì•¼ í•©ë‹ˆë‹¤.

```bash
cd backend
```

## 2. í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ í†µí•´ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ìž”ê³  ì¡°íšŒ, í˜„ìž¬ê°€ ì¡°íšŒ, ì£¼ë¬¸ ì „ì†¡(í…ŒìŠ¤íŠ¸) ê³¼ì •ì„ ìˆœì°¨ì ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.

```bash
go run cmd/test_trade/main.go
```

## 3. ê²°ê³¼ í™•ì¸ ë°©ë²•

ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë¡œê·¸ë¥¼ í†µí•´ ì„±ê³µ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

### âœ… ì„±ê³µ ì¼€ì´ìŠ¤

1. **í† í° ë°œê¸‰/ê°±ì‹ **
   ```
   [KIS] Token expires at: ... (ìœ íš¨ê¸°ê°„ í‘œì‹œ)
   ```
   
2. **ìž”ê³  ì¡°íšŒ (GetBalance)**
   ```
   [KIS] âœ“ GetBalance: Found X holdings ...
   ```
   ë³´ìœ  ì¢…ëª© ë¦¬ìŠ¤íŠ¸ê°€ ì¶œë ¥ë˜ë©´ ê³„ì¢Œë²ˆí˜¸ì™€ API í‚¤ê°€ ì •ìƒìž…ë‹ˆë‹¤.

3. **í˜„ìž¬ê°€ ì¡°íšŒ (GetCurrentPrice)**
   ```
   [KIS] âœ“ GetCurrentPrice: NAS:TQQQ = $...
   ```
   TQQQ ê°€ê²©ì´ ì •ìƒì ìœ¼ë¡œ ì¶œë ¥ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

4. **ì£¼ë¬¸ ì „ì†¡ (PlaceOrder)**
   - **ìž¥ ìš´ì˜ ì‹œê°„ì¸ ê²½ìš°**: ì£¼ë¬¸ ì„±ê³µ ë©”ì‹œì§€
   - **ìž¥ ìš´ì˜ ì‹œê°„ì´ ì•„ë‹Œ ê²½ìš°**: ì•„ëž˜ì™€ ê°™ì€ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ëœ¨ë”ë¼ë„ **API ì—°ë™ ìžì²´ëŠ” ì„±ê³µ**í•œ ê²ƒìž…ë‹ˆë‹¤.
     ```
     Response Code: 7, Msg: ìž¥ìš´ì˜ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤ ...
     ```
     ë˜ëŠ”
     ```
     Response Code: 7, Msg: ì—í”„í„°ë§ˆì¼“ ì—°ìž¥ì°¸ì—¬ ì‹ ì²­ê³„ì¢Œë§Œ ì£¼ë¬¸ ê°€ëŠ¥ í•©ë‹ˆë‹¤.
     ```

### âŒ ì‹¤íŒ¨ ì¼€ì´ìŠ¤ (ìžì£¼ ë°œìƒí•˜ëŠ” ì—ëŸ¬)

1. **ì¸ì¦ ì‹¤íŒ¨ (401 Unauthorized, gws-exception ë“±)**
   - `.env` íŒŒì¼ì˜ `KIS_APP_KEY`, `KIS_APP_SECRET`ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.
   - í‚¤ ê°’ì— ê³µë°±ì´ í¬í•¨ë˜ì–´ ìžˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

2. **ê³„ì¢Œë²ˆí˜¸ ì˜¤ë¥˜ (INVALID_CHECK_ACNO)**
   - `.env`ì˜ `KIS_ACCOUNT_NUM`ì´ ì •í™•í•œì§€ í™•ì¸í•˜ì„¸ìš”. (ì¢…í•©ê³„ì¢Œë²ˆí˜¸ 8ìžë¦¬)
   - ëª¨ì˜íˆ¬ìžê°€ ì•„ë‹Œ **ì‹¤ì „íˆ¬ìž** ê³„ì¢Œì¸ì§€ í™•ì¸í•˜ì„¸ìš”. (API URLì´ ì‹¤ì „ìš©ìœ¼ë¡œ ì„¤ì •ë¨)

3. **í† í° íŒŒì¼ ë¬¸ì œ**
   - ë§Œì•½ ê³„ì† ì¸ì¦ ì—ëŸ¬ê°€ ë‚œë‹¤ë©´, ê¸°ì¡´ì— ë°œê¸‰ë°›ì€ í† í° íŒŒì¼ì´ ê¼¬ì˜€ì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
   - `backend/kis_token.json` íŒŒì¼ì„ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ì‹¤í–‰í•´ë³´ì„¸ìš”.
   ```bash
   rm kis_token.json
   ```

## 4. ì°¸ê³  ì‚¬í•­
- ì´ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì‹¤ì œ ì£¼ë¬¸ì„ ì „ì†¡í•˜ë¯€ë¡œ, **ìž¥ ìš´ì˜ ì‹œê°„ì— ì‹¤í–‰ ì‹œ ì‹¤ì œ ë§¤ìˆ˜/ë§¤ë„ê°€ ë°œìƒ**í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
- í…ŒìŠ¤íŠ¸ ëª©ì ìœ¼ë¡œ ì‹¤í–‰í•  ë•ŒëŠ” ìž¥ ìš´ì˜ ì‹œê°„ì´ ì•„ë‹ ë•Œ í•˜ê±°ë‚˜, ê³„ì¢Œì— ìž”ê³ ë¥¼ ë¹„ì›Œë‘ëŠ” ê²ƒì„ ê¶Œìž¥í•©ë‹ˆë‹¤ (í˜¹ì€ ì†Œì•¡ë§Œ).

---

## 5. ì™¸ë¶€ ë°ì´í„° ì œê³µ API (Market Data Service)

ì´ ì„œë²„ëŠ” ìˆ˜ì§‘í•œ 1ë¶„ë´‰ ë°ì´í„°(Alpaca Source)ë¥¼ ì™¸ë¶€ì—ì„œ ì¡°íšŒí•  ìˆ˜ ìžˆëŠ” HTTP APIë¥¼ ì œê³µí•©ë‹ˆë‹¤.

### ðŸ•¯ï¸ ë¶„ë´‰ ì¡°íšŒ (Get Candles)

ì§€ì •ëœ ì¢…ëª©ì˜ 1ë¶„ë´‰ ë°ì´í„°ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.

- **URL**: `/api/market/candles`
- **Method**: `GET`
- **Query Parameters**:
  - `symbol`: ì¢…ëª© ì‹¬ë³¼ (ì˜ˆ: `TQQQ`, `AAPL`)
  - `start`: ì‹œìž‘ ë‚ ì§œ (`YYYY-MM-DD`)
  - `end`: ì¢…ë£Œ ë‚ ì§œ (`YYYY-MM-DD`)

#### ìš”ì²­ ì˜ˆì‹œ (Curl)

```bash
# TQQQì˜ 2024-01-01 ~ 2024-01-31 ë¶„ë´‰ ë°ì´í„° ì¡°íšŒ
curl "http://localhost:8082/api/market/candles?symbol=TQQQ&start=2024-01-01&end=2024-01-31" | jq
```

#### ì‘ë‹µ í˜•ì‹ (JSON)

```json
{
  "symbol": "TQQQ",
  "count": 5000,
  "data": [
    {
      "symbol": "TQQQ",
      "timestamp": 1704100200000,
      "open": 50.1,
      "high": 50.5,
      "low": 50.0,
      "close": 50.2,
      "volume": 1000
    },
    ...
  ]
}
```

### ðŸ“¥ ë°ì´í„° ë°±í•„ (Backfill)

Alpacaì—ì„œ ê³¼ê±° ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì—¬ Parquet íŒŒì¼ë¡œ ì €ìž¥í•©ë‹ˆë‹¤.

- **URL**: `/api/market/backfill`
- **Method**: `POST`
- **Query Parameters**:
  - `start`: ì‹œìž‘ ë‚ ì§œ (`YYYY-MM-DD`)
  - `end`: ì¢…ë£Œ ë‚ ì§œ (`YYYY-MM-DD`)

#### ìš”ì²­ ì˜ˆì‹œ (Curl)

```bash
# 2026-01-01ë¶€í„° 2026-01-15ê¹Œì§€ ë°ì´í„° ìˆ˜ì§‘ (ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰)
curl -X POST "http://localhost:8082/api/market/backfill?start=2026-01-01&end=2026-01-15"

# ì‘ë‹µ (202 Accepted)
{"status":"Backfill triggered","start":"2026-01-01","end":"2026-01-15","note":"Check server logs for progress"}
```

### ðŸ› ï¸ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

1. **`Market data service not available` ì˜¤ë¥˜**
   - DuckDB ì´ˆê¸°í™” ì‹¤íŒ¨. ì„œë²„ ë¡œê·¸ í™•ì¸: `docker logs tqqq-backend`
   - Parquet íŒŒì¼ ê²½ë¡œ í™•ì¸: `data/market_data/resolution=1min/`ì— íŒŒì¼ì´ ìžˆëŠ”ì§€ í™•ì¸

2. **`count: 0` (ë¹ˆ ê²°ê³¼)**
   - ë¨¼ì € Backfill APIë¡œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í–ˆëŠ”ì§€ í™•ì¸
   - ìš”ì²­í•œ ë‚ ì§œ ë²”ìœ„ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ìžˆëŠ”ì§€ í™•ì¸

3. **`invalid symbol` ì˜¤ë¥˜ (Backfill ì‹œ)**
   - `BRK-A` ê°™ì€ ì‹¬ë³¼ì€ `BRK.A`ë¡œ í‘œê¸°í•´ì•¼ í•¨ (Alpaca ê·œì¹™)
   - `backend/config/symbols.json` íŒŒì¼ í™•ì¸

### â° ì¼ì¼ ë°°ì¹˜ ì„¤ì • (Crontab)

ë§¤ì¼ ìƒˆë²½ 2ì‹œì— ì „ë‚  ë°ì´í„°ë¥¼ ìžë™ ìˆ˜ì§‘í•˜ë ¤ë©´:

```bash
crontab -e
# ì•„ëž˜ ë‚´ìš© ì¶”ê°€
0 2 * * * curl -X POST "http://localhost:8082/api/market/backfill?start=$(date -d 'yesterday' +\%Y-\%m-\%d)&end=$(date -d 'yesterday' +\%Y-\%m-\%d)" >> /var/log/market_backfill.log 2>&1
```